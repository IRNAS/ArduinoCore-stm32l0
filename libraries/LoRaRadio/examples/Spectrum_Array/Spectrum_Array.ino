#include "LoRaRadio.h"

#define NUM_FREQ 348
int16_t rssi_values[NUM_FREQ];
float frequencies[NUM_FREQ] = {
935 ,890,
935.2, 890.2,
935.4, 890.4,
935.6, 890.6,
935.8, 890.8,
936 , 891,
936.2, 891.2,
936.4, 891.4,
936.6, 891.6,
936.8, 891.8,
937 , 892,
937.2, 892.2,
937.4, 892.4,
937.6, 892.6,
937.8, 892.8,
938 , 893,
938.2, 893.2,
938.4, 893.4,
938.6, 893.6,
938.8, 893.8,
939 , 894,
939.2, 894.2,
939.4, 894.4,
939.6, 894.6,
939.8, 894.8,
940 , 895,
940.2, 895.2,
940.4, 895.4,
940.6, 895.6,
940.8, 895.8,
941 , 896,
941.2, 896.2,
941.4, 896.4,
941.6, 896.6,
941.8, 896.8,
942 , 897,
942.2, 897.2,
942.4, 897.4,
942.6, 897.6,
942.8, 897.8,
943 , 898,
943.2, 898.2,
943.4, 898.4,
943.6, 898.6,
943.8, 898.8,
944 , 899,
944.2, 899.2,
944.4, 899.4,
944.6, 899.6,
944.8, 899.8,
945 , 900,
945.2, 900.2,
945.4, 900.4,
945.6, 900.6,
945.8, 900.8,
946 , 901,
946.2, 901.2,
946.4, 901.4,
946.6, 901.6,
946.8, 901.8,
947 , 902,
947.2, 902.2,
947.4, 902.4,
947.6, 902.6,
947.8, 902.8,
948 , 903,
948.2, 903.2,
948.4, 903.4,
948.6, 903.6,
948.8, 903.8,
949 , 904,
949.2, 904.2,
949.4, 904.4,
949.6, 904.6,
949.8, 904.8,
950 , 905,
950.2, 905.2,
950.4, 905.4,
950.6, 905.6,
950.8, 905.8,
951 , 906,
951.2, 906.2,
951.4, 906.4,
951.6, 906.6,
951.8, 906.8,
952 , 907,
952.2, 907.2,
952.4, 907.4,
952.6, 907.6,
952.8, 907.8,
953 , 908,
953.2, 908.2,
953.4, 908.4,
953.6, 908.6,
953.8, 908.8,
954 , 909,
954.2, 909.2,
954.4, 909.4,
954.6, 909.6,
954.8, 909.8,
955 , 910,
955.2, 910.2,
955.4, 910.4,
955.6, 910.6,
955.8, 910.8,
956 , 911,
956.2, 911.2,
956.4, 911.4,
956.6, 911.6,
956.8, 911.8,
957 , 912,
957.2, 912.2,
957.4, 912.4,
957.6, 912.6,
957.8, 912.8,
958 , 913,
958.2, 913.2,
958.4, 913.4,
958.6, 913.6,
958.8, 913.8,
959 , 914,
959.2, 914.2,
959.4, 914.4,
959.6, 914.6,
959.8, 914.8,
925.2, 880.2,
925.4, 880.4,
925.6, 880.6,
925.8, 880.8,
926, 881,
926.2, 881.2,
926.4, 881.4,
926.6, 881.6,
926.8, 881.8,
927, 882,
927.2, 882.2,
927.4, 882.4,
927.6, 882.6,
927.8, 882.8,
928, 883,
928.2, 883.2,
928.4, 883.4,
928.6, 883.6,
928.8, 883.8,
929, 884,
929.2, 884.2,
929.4, 884.4,
929.6, 884.6,
929.8, 884.8,
930, 885,
930.2, 885.2,
930.4, 885.4,
930.6, 885.6,
930.8, 885.8,
931, 886,
931.2, 886.2,
931.4, 886.4,
931.6, 886.6,
931.8, 886.8,
932, 887,
932.2, 887.2,
932.4, 887.4,
932.6, 887.6,
932.8, 887.8,
933, 888,
933.2, 888.2,
933.4, 888.4,
933.6, 888.6,
933.8, 888.8,
934, 889,
934.2, 889.2,
934.4, 889.4,
934.6, 889.6,
934.8, 889.8,};

void setup( void )
{
    Serial.begin(500000);
    
    while (!Serial) { }

    LoRaRadio.begin(868000000);

    LoRaRadio.setFrequency(868000000);
    LoRaRadio.setTxPower(14);
    LoRaRadio.setBandwidth(LoRaRadio.BW_125);
    LoRaRadio.setSpreadingFactor(LoRaRadio.SF_7);
    LoRaRadio.setCodingRate(LoRaRadio.CR_4_5);
    LoRaRadio.setLnaBoost(true);
    
    pinMode(PB6, OUTPUT);
}

void loop( void )
{
    char uart_buffer[100];
    bool received_token = false;

    while(!received_token)
    {
        Serial.println("READY_TOKEN");
        digitalWrite(PB6, HIGH);
        delay(1);
        digitalWrite(PB6, LOW);

        if (Serial.available()) 
        {      
            Serial.readBytesUntil('\n', uart_buffer, 100);

            if(memcmp(uart_buffer, "START_TOKEN", 11) == 0)
            {
                //Serial.println("Starting spectrum scan");
                received_token = true;
            }
            // Clean buffer
            memset(uart_buffer, 0, 100);
        }
    }

    LoRaRadio.readSpectrumArray(frequencies, rssi_values, NUM_FREQ);
       
    Serial.println("PRINT_TOKEN"); 
    for(uint16_t i = 0; i < NUM_FREQ; i++)
    {
        Serial.print(frequencies[i]);
        Serial.print(",");
        Serial.println(rssi_values[i]);
    }

    Serial.println("DONE_TOKEN"); 
}

